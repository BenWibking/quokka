/// \file planck_integral.hpp
/// \brief Some functions for quickly integrating the Planck function.

#include <algorithm>
#include <cmath>

#include "AMReX.H"
#include "AMReX_BLassert.H"
#include "AMReX_Extension.H"
#include "AMReX_GpuQualifiers.H"
#include "AMReX_REAL.H"

#include "valarray.hpp"
// #include "interpolate.cpp"

#define LIKELY_IN_CACHE_SIZE 8

using Real = amrex::Real;

static constexpr double PI = 3.14159265358979323846;
static constexpr Real gInf = PI * PI * PI * PI / 15.0;
static constexpr int INTERP_SIZE = 1000;
static constexpr Real LOG_X_MIN = -3.;
static constexpr Real LOG_X_MAX = 2.;
static constexpr amrex::GpuArray<Real, INTERP_SIZE> Y_interp{
    3.33208350000010e-10, 3.44928439096200e-10, 3.57060746231957e-10, 3.69619769058376e-10, 3.82620515067006e-10, 3.96078519517337e-10, 4.10009863995011e-10,
    4.24431195622159e-10, 4.39359746943423e-10, 4.54813356510919e-10, 4.70810490193028e-10, 4.87370263232280e-10, 5.04512463078796e-10, 5.22257573026384e-10,
    5.40626796679774e-10, 5.59642083281683e-10, 5.79326153930806e-10, 5.99702528721012e-10, 6.20795554834866e-10, 6.42630435624893e-10, 6.65233260716799e-10,
    6.88631037171632e-10, 7.12851721742690e-10, 7.37924254266746e-10, 7.63878592229335e-10, 7.90745746544706e-10, 8.18557818593682e-10, 8.47348038563870e-10,
    8.77150805136906e-10, 9.08001726571802e-10, 9.39937663231312e-10, 9.72996771604276e-10, 1.00721854987449e-09, 1.04264388509229e-09, 1.07931510200322e-09,
    1.11727601359401e-09, 1.15657197341488e-09, 1.19724992974070e-09, 1.23935848163641e-09, 1.28294793699276e-09, 1.32807037260193e-09, 1.37477969634515e-09,
    1.42313171156555e-09, 1.47318418370403e-09, 1.52499690927684e-09, 1.57863178727795e-09, 1.63415289309047e-09, 1.69162655499674e-09, 1.75112143337633e-09,
    1.81270860268801e-09, 1.87646163633339e-09, 1.94245669450264e-09, 2.01077261510743e-09, 2.08149100791004e-09, 2.15469635196070e-09, 2.23047609645809e-09,
    2.30892076515599e-09, 2.39012406443799e-09, 2.47418299519028e-09, 2.56119796860646e-09, 2.65127292606113e-09, 2.74451546319705e-09, 2.84103695837117e-09,
    2.94095270561574e-09, 3.04438205227166e-09, 3.15144854145673e-09, 3.26228005954178e-09, 3.37700898880745e-09, 3.49577236546628e-09, 3.61871204323661e-09,
    3.74597486266373e-09, 3.87771282639155e-09, 4.01408328059093e-09, 4.15524910276436e-09, 4.30137889614750e-09, 4.45264719094296e-09, 4.60923465262228e-09,
    4.77132829754719e-09, 4.93912171616666e-09, 5.11281530405505e-09, 5.29261650106652e-09, 5.47874003889254e-09, 5.67140819731582e-09, 5.87085106946591e-09,
    6.07730683639362e-09, 6.29102205129235e-09, 6.51225193370087e-09, 6.74126067404448e-09, 6.97832174887061e-09, 7.22371824716057e-09, 7.47774320810080e-09,
    7.74069997072083e-09, 8.01290253581186e-09, 8.29467594055641e-09, 8.58635664631773e-09, 8.88829294004973e-09, 9.20084534980385e-09, 9.52438707483223e-09,
    9.85930443079352e-09, 1.02059973105985e-08, 1.05648796614358e-08, 1.09363799785554e-08, 1.13209418163902e-08, 1.17190243176277e-08, 1.21311027608621e-08,
    1.25576691274780e-08, 1.29992326884401e-08, 1.34563206116886e-08, 1.39294785908621e-08, 1.44192714961005e-08, 1.49262840476959e-08, 1.54511215133969e-08,
    1.59944104302017e-08, 1.65567993514864e-08, 1.71389596203705e-08, 1.77415861702333e-08, 1.83653983533317e-08, 1.90111407985157e-08, 1.96795842990488e-08,
    2.03715267316008e-08, 2.10877940074979e-08, 2.18292410573702e-08, 2.25967528503609e-08, 2.33912454491121e-08, 2.42136671017842e-08, 2.50649993724042e-08,
    2.59462583108913e-08, 2.68584956641459e-08, 2.78028001296496e-08, 2.87802986530606e-08, 2.97921577713461e-08, 3.08395850030630e-08, 3.19238302874182e-08,
    3.30461874738345e-08, 3.42079958637907e-08, 3.54106418067667e-08, 3.66555603521857e-08, 3.79442369593296e-08, 3.92782092672459e-08, 4.06590689267598e-08,
    4.20884634967612e-08, 4.35680984070293e-08, 4.50997389899122e-08, 4.66852125832901e-08, 4.83264107073128e-08, 5.00252913174994e-08, 5.17838811368729e-08,
    5.36042780699057e-08, 5.54886537011396e-08, 5.74392558814428e-08, 5.94584114049871e-08, 6.15485287801120e-08, 6.37121010973702e-08, 6.59517089981604e-08,
    6.82700237474681e-08, 7.06698104143693e-08, 7.31539311640578e-08, 7.57253486653182e-08, 7.83871296174810e-08, 8.11424484010414e-08, 8.39945908562823e-08,
    8.69469581943732e-08, 9.00030710455996e-08, 9.31665736495065e-08, 9.64412381919419e-08, 9.98309692941291e-08, 1.03339808659111e-07, 1.06971939881050e-07,
    1.10731693423113e-07, 1.14623551769811e-07, 1.18652154759940e-07, 1.22822305106409e-07, 1.27138974109508e-07, 1.31607307570400e-07, 1.36232631911831e-07,
    1.41020460513300e-07, 1.45976500268218e-07, 1.51106658370807e-07, 1.56417049340779e-07, 1.61914002294121e-07, 1.67604068468582e-07, 1.73494029012792e-07,
    1.79590903048218e-07, 1.85901956013499e-07, 1.92434708301061e-07, 1.99196944196202e-07, 2.06196721129232e-07, 2.13442379251642e-07, 2.20942551347594e-07,
    2.28706173092475e-07, 2.36742493670648e-07, 2.45061086764967e-07, 2.53671861931006e-07, 2.62585076369521e-07, 2.71811347110989e-07, 2.81361663626691e-07,
    2.91247400881179e-07, 3.01480332841622e-07, 3.12072646459915e-07, 3.23036956144146e-07, 3.34386318736446e-07, 3.46134249014967e-07, 3.58294735738252e-07,
    3.70882258250978e-07, 3.83911803670617e-07, 3.97398884675396e-07, 4.11359557914439e-07, 4.25810443061903e-07, 4.40768742537532e-07, 4.56252261916931e-07,
    4.72279431055604e-07, 4.88869325951676e-07, 5.06041691373084e-07, 5.23816964275920e-07, 5.42216298041478e-07, 5.61261587560645e-07, 5.80975495195135e-07,
    6.01381477646160e-07, 6.22503813762210e-07, 6.44367633318683e-07, 6.66998946803201e-07, 6.90424676241788e-07, 7.14672687102082e-07, 7.39771821311164e-07,
    7.65751931426905e-07, 7.92643916002946e-07, 8.20479756188955e-07, 8.49292553609229e-07, 8.79116569564064e-07, 9.09987265600142e-07, 9.41941345497435e-07,
    9.75016798722140e-07, 1.00925294539651e-06, 1.04469048283858e-06, 1.08137153372628e-06, 1.11933969594263e-06, 1.15864009416037e-06, 1.19931943322670e-06,
    1.24142605341074e-06, 1.28500998757834e-06, 1.33012302036166e-06, 1.37681874939248e-06, 1.42515264867131e-06, 1.47518213414650e-06, 1.52696663158008e-06,
    1.58056764677996e-06, 1.63604883828071e-06, 1.69347609255798e-06, 1.75291760186459e-06, 1.81444394477949e-06, 1.87812816956368e-06, 1.94404588042072e-06,
    2.01227532676260e-06, 2.08289749558542e-06, 2.15599620706273e-06, 2.23165821346837e-06, 2.30997330154424e-06, 2.39103439843261e-06, 2.47493768129661e-06,
    2.56178269075688e-06, 2.65167244827677e-06, 2.74471357763284e-06, 2.84101643061262e-06, 2.94069521708582e-06, 3.04386813960092e-06, 3.15065753266368e-06,
    3.26119000685995e-06, 3.37559659799057e-06, 3.49401292139194e-06, 3.61657933162184e-06, 3.74344108769620e-06, 3.87474852406910e-06, 4.01065722755479e-06,
    4.15132822039700e-06, 4.29692814969868e-06, 4.44762948343189e-06, 4.60361071325545e-06, 4.76505656437576e-06, 4.93215821269413e-06, 5.10511350949273e-06,
    5.28412721391933e-06, 5.46941123354037e-06, 5.66118487324113e-06, 5.85967509276096e-06, 6.06511677316213e-06, 6.27775299253994e-06, 6.49783531129383e-06,
    6.72562406728870e-06, 6.96138868124762e-06, 7.20540797272926e-06, 7.45797048705416e-06, 7.71937483355792e-06, 7.98993003556115e-06, 8.26995589245995e-06,
    8.55978335435446e-06, 8.85975490964696e-06, 9.17022498605617e-06, 9.49156036550942e-06, 9.82414061338988e-06, 1.01683585226331e-05, 1.05246205731830e-05,
    1.08933474073354e-05, 1.12749743215151e-05, 1.16699517750521e-05, 1.20787459165381e-05, 1.25018391283707e-05, 1.29397305901061e-05, 1.33929368612685e-05,
    1.38619924842815e-05, 1.43474506082135e-05, 1.48498836340491e-05, 1.53698838822254e-05, 1.59080642831954e-05, 1.64650590918076e-05, 1.70415246263177e-05,
    1.76381400328741e-05, 1.82556080763503e-05, 1.88946559584256e-05, 1.95560361638440e-05, 2.02405273358169e-05, 2.09489351815637e-05, 2.16820934090207e-05,
    2.24408646957819e-05, 2.32261416913735e-05, 2.40388480539969e-05, 2.48799395229182e-05, 2.57504050277188e-05, 2.66512678356627e-05, 2.75835867384806e-05,
    2.85484572799116e-05, 2.95470130253914e-05, 3.05804268753202e-05, 3.16499124233928e-05, 3.27567253615238e-05, 3.39021649329502e-05, 3.50875754351492e-05,
    3.63143477742624e-05, 3.75839210727738e-05, 3.88977843322504e-05, 4.02574781530098e-05, 4.16645965126472e-05, 4.31207886054139e-05, 4.46277607445092e-05,
    4.61872783294148e-05, 4.78011678804717e-05, 4.94713191429751e-05, 5.11996872631348e-05, 5.29882950383297e-05, 5.48392352441665e-05, 5.67546730409316e-05,
    5.87368484621157e-05, 6.07880789877794e-05, 6.29107622056145e-05, 6.51073785626586e-05, 6.73804942107107e-05, 6.97327639486016e-05, 7.21669342645744e-05,
    7.46858464821396e-05, 7.72924400128783e-05, 7.99897557197842e-05, 8.27809393948496e-05, 8.56692453547283e-05, 8.86580401584276e-05, 9.17508064511160e-05,
    9.49511469382667e-05, 9.82627884944949e-05, 1.01689586411586e-04, 1.05235528790371e-04, 1.08904741081235e-04, 1.12701490778235e-04, 1.16630192271924e-04,
    1.20695411866187e-04, 1.24901872964529e-04, 1.29254461431464e-04, 1.33758231134814e-04, 1.38418409674930e-04, 1.43240404307037e-04, 1.48229808063103e-04,
    1.53392406079840e-04, 1.58734182139678e-04, 1.64261325431721e-04, 1.69980237540004e-04, 1.75897539666505e-04, 1.82020080096704e-04, 1.88354941915656e-04,
    1.94909450982836e-04, 2.01691184174290e-04, 2.08707977900850e-04, 2.15967936911517e-04, 2.23479443391345e-04, 2.31251166363502e-04, 2.39292071405463e-04,
    2.47611430689623e-04, 2.56218833358937e-04, 2.65124196248536e-04, 2.74337774964600e-04, 2.83870175332147e-04, 2.93732365223758e-04, 3.03935686781609e-04,
    3.14491869045623e-04, 3.25413041000914e-04, 3.36711745058115e-04, 3.48400950980631e-04, 3.60494070273268e-04, 3.73004971047161e-04, 3.85947993376367e-04,
    3.99337965161992e-04, 4.13190218520198e-04, 4.27520606710934e-04, 4.42345521624786e-04, 4.57681911845836e-04, 4.73547301309011e-04, 4.89959808570940e-04,
    5.06938166713939e-04, 5.24501743903342e-04, 5.42670564618992e-04, 5.61465331582384e-04, 5.80907448401556e-04, 6.01019042956527e-04, 6.21822991548760e-04,
    6.43342943838848e-04, 6.65603348597312e-04, 6.88629480294212e-04, 7.12447466553979e-04, 7.37084316502709e-04, 7.62567950035948e-04, 7.88927228035836e-04,
    8.16191983567356e-04, 8.44393054084268e-04, 8.73562314676266e-04, 9.03732712389774e-04, 9.34938301655777e-04, 9.67214280859060e-04, 1.00059703008421e-03,
    1.03512415007477e-03, 1.07083450244304e-03, 1.10776825116900e-03, 1.14596690542798e-03, 1.18547336378799e-03, 1.22633195981845e-03, 1.26858850915365e-03,
    1.31229035805515e-03, 1.35748643351889e-03, 1.40422729497371e-03, 1.45256518761977e-03, 1.50255409745613e-03, 1.55424980804873e-03, 1.60770995909090e-03,
    1.66299410681035e-03, 1.72016378627785e-03, 1.77928257567443e-03, 1.84041616257545e-03, 1.90363241231138e-03, 1.96900143846704e-03, 2.03659567558217e-03,
    2.10648995411860e-03, 2.17876157776023e-03, 2.25349040311453e-03, 2.33075892188550e-03, 2.41065234559014e-03, 2.49325869289236e-03, 2.57866887963004e-03,
    2.66697681161292e-03, 2.75827948027115e-03, 2.85267706123606e-03, 2.95027301593707e-03, 3.05117419630044e-03, 3.15549095263805e-03, 3.26333724481618e-03,
    3.37483075679681e-03, 3.49009301464596e-03, 3.60924950810594e-03, 3.73242981583070e-03, 3.85976773438595e-03, 3.99140141111766e-03, 4.12747348099557e-03,
    4.26813120754027e-03, 4.41352662794518e-03, 4.56381670250706e-03, 4.71916346848142e-03, 4.87973419848166e-03, 5.04570156354323e-03, 5.21724380097691e-03,
    5.39454488713786e-03, 5.57779471523967e-03, 5.76718927834550e-03, 5.96293085767073e-03, 6.16522821633469e-03, 6.37429679870144e-03, 6.59035893545221e-03,
    6.81364405453519e-03, 7.04438889814084e-03, 7.28283774585337e-03, 7.52924264413235e-03, 7.78386364228060e-03, 8.04696903505724e-03, 8.31883561209779e-03,
    8.59974891430546e-03, 8.89000349738050e-03, 9.18990320265718e-03, 9.49976143542029e-03, 9.81990145087566e-03, 1.01506566479516e-02, 1.04923708711103e-02,
    1.08453987203512e-02, 1.12101058695895e-02, 1.15868693935958e-02, 1.19760781036851e-02, 1.23781328923445e-02, 1.27934470869910e-02, 1.32224468130541e-02,
    1.36655713665753e-02, 1.41232735965236e-02, 1.45960202970225e-02, 1.50842926096873e-02, 1.55885864362723e-02, 1.61094128618282e-02, 1.66472985885689e-02,
    1.72027863806495e-02, 1.77764355200550e-02, 1.83688222738014e-02, 1.89805403726470e-02, 1.96122015015137e-02, 2.02644358018161e-02, 2.09378923858932e-02,
    2.16332398637377e-02, 2.23511668822141e-02, 2.30923826769541e-02, 2.38576176371161e-02, 2.46476238831900e-02, 2.54631758580253e-02, 2.63050709312564e-02,
    2.71741300172925e-02, 2.80711982070352e-02, 2.89971454134789e-02, 2.99528670313441e-02, 3.09392846108839e-02, 3.19573465459972e-02, 3.30080287767721e-02,
    3.40923355065740e-02, 3.52112999337807e-02, 3.63659849982569e-02, 3.75574841426474e-02, 3.87869220885535e-02, 4.00554556276456e-02, 4.13642744277471e-02,
    4.27146018539095e-02, 4.41076958044799e-02, 4.55448495621449e-02, 4.70273926599137e-02, 4.85566917619827e-02, 5.01341515593992e-02, 5.17612156804229e-02,
    5.34393676154511e-02, 5.51701316563546e-02, 5.69550738500361e-02, 5.87958029659970e-02, 6.06939714776659e-02, 6.26512765572071e-02, 6.46694610834948e-02,
    6.67503146628993e-02, 6.88956746624944e-02, 7.11074272552520e-02, 7.33875084767499e-02, 7.57379052928707e-02, 7.81606566779246e-02, 8.06578547025780e-02,
    8.32316456309191e-02, 8.58842310259361e-02, 8.86178688626283e-02, 9.14348746479108e-02, 9.43376225464109e-02, 9.73285465111919e-02, 1.00410141418370e-01,
    1.03584964204525e-01, 1.06855635005723e-01, 1.10224838296911e-01, 1.13695324030349e-01, 1.17269908771657e-01, 1.20951476832014e-01, 1.24742981394887e-01,
    1.28647445635651e-01, 1.32667963832309e-01, 1.36807702465465e-01, 1.41069901305575e-01, 1.45457874485415e-01, 1.49975011555587e-01, 1.54624778520787e-01,
    1.59410718854428e-01, 1.64336454489113e-01, 1.69405686780319e-01, 1.74622197440541e-01, 1.79989849441014e-01, 1.85512587877999e-01, 1.91194440800491e-01,
    1.97039519996076e-01, 2.03052021731523e-01, 2.09236227444542e-01, 2.15596504383031e-01, 2.22137306187946e-01, 2.28863173415821e-01, 2.35778733996782e-01,
    2.42888703623772e-01, 2.50197886068534e-01, 2.57711173419756e-01, 2.65433546238609e-01, 2.73370073626786e-01, 2.81525913201944e-01, 2.89906310975340e-01,
    2.98516601126274e-01, 3.07362205667779e-01, 3.16448633997892e-01, 3.25781482330624e-01, 3.35366433000646e-01, 3.45209253635543e-01, 3.55315796189326e-01,
    3.65691995830777e-01, 3.76343869680051e-01, 3.87277515386832e-01, 3.98499109543214e-01, 4.10014905924358e-01, 4.21831233549873e-01, 4.33954494558766e-01,
    4.46391161890698e-01, 4.59147776766241e-01, 4.72230945958719e-01, 4.85647338850183e-01, 4.99403684264039e-01, 5.13506767066788e-01, 5.27963424531367e-01,
    5.42780542454548e-01, 5.57965051020930e-01, 5.73523920406038e-01, 5.89464156111194e-01, 6.05792794022846e-01, 6.22516895189209e-01, 6.39643540307195e-01,
    6.57179823912781e-01, 6.75132848268197e-01, 6.93509716939493e-01, 7.12317528058392e-01, 7.31563367262557e-01, 7.51254300308801e-01, 7.71397365354136e-01,
    7.91999564899932e-01, 8.13067857394990e-01, 8.34609148493775e-01, 8.56630281966636e-01, 8.79138030259433e-01, 9.02139084700634e-01, 9.25640045354616e-01,
    9.49647410520714e-01, 9.74167565878274e-01, 9.99206773278894e-01, 1.02477115918791e+00, 1.05086670277814e+00, 1.07749922367995e+00, 1.10467436939280e+00,
    1.13239760236443e+00, 1.16067418674529e+00, 1.18950917482685e+00, 1.21890739317384e+00, 1.24887342846178e+00, 1.27941161303279e+00, 1.31052601018375e+00,
    1.34222039920300e+00, 1.37449826017266e+00, 1.40736275855609e+00, 1.44081672959093e+00, 1.47486266251049e+00, 1.50950268461780e+00, 1.54473854523840e+00,
    1.58057159957993e+00, 1.61700279252848e+00, 1.65403264241345e+00, 1.69166122477476e+00, 1.72988815616806e+00, 1.76871257804559e+00, 1.80813314075242e+00,
    1.84814798767948e+00, 1.88875473961696e+00, 1.92995047935341e+00, 1.97173173656780e+00, 2.01409447306359e+00, 2.05703406839551e+00, 2.10054530594169e+00,
    2.14462235947509e+00, 2.18925878028977e+00, 2.23444748493909e+00, 2.28018074364399e+00, 2.32645016943064e+00, 2.37324670805803e+00, 2.42056062879638e+00,
    2.46838151611838e+00, 2.51669826236542e+00, 2.56549906145127e+00, 2.61477140366571e+00, 2.66450207164031e+00, 2.71467713753823e+00, 2.76528196152881e+00,
    2.81630119160717e+00, 2.86771876481717e+00, 2.91951790993492e+00, 2.97168115166766e+00, 3.02419031642079e+00, 3.07702653968307e+00, 3.13017027507707e+00,
    3.18360130511856e+00, 3.23729875372481e+00, 3.29124110050777e+00, 3.34540619688355e+00, 3.39977128402485e+00, 3.45431301267792e+00, 3.50900746485977e+00,
    3.56383017744594e+00, 3.61875616765239e+00, 3.67375996040884e+00, 3.72881561761402e+00, 3.78389676925571e+00, 3.83897664637159e+00, 3.89402811581860e+00,
    3.94902371681107e+00, 4.00393569917937e+00, 4.05873606329279e+00, 4.11339660158172e+00, 4.16788894158588e+00, 4.22218459044657e+00, 4.27625498075265e+00,
    4.33007151764095e+00, 4.38360562704402e+00, 4.43682880496914e+00, 4.48971266768508e+00, 4.54222900268474e+00, 4.59434982028456e+00, 4.64604740571434e+00,
    4.69729437154437e+00, 4.74806371029043e+00, 4.79832884703162e+00, 4.84806369187073e+00, 4.89724269206236e+00, 4.94584088363031e+00, 4.99383394229257e+00,
    5.04119823351004e+00, 5.08791086147381e+00, 5.13394971684510e+00, 5.17929352306247e+00, 5.22392188103236e+00, 5.26781531202110e+00, 5.31095529857009e+00,
    5.35332432326001e+00, 5.39490590515549e+00, 5.43568463376779e+00, 5.47564620038082e+00, 5.51477742659378e+00, 5.55306628994357e+00, 5.59050194648012e+00,
    5.62707475017939e+00, 5.66277626909057e+00, 5.69759929812736e+00, 5.73153786842674e+00, 5.76458725321315e+00, 5.79674397012108e+00, 5.82800577994463e+00,
    5.85837168179866e+00, 5.88784190469273e+00, 5.91641789553545e+00, 5.94410230360389e+00, 5.97089896152959e+00, 5.99681286286937e+00, 6.02185013634606e+00,
    6.04601801686044e+00, 6.06932481339164e+00, 6.09177987391900e+00, 6.11339354751274e+00, 6.13417714375537e+00, 6.15414288966877e+00, 6.17330388433402e+00,
    6.19167405140297e+00, 6.20926808970974e+00, 6.22610142220029e+00, 6.24219014340501e+00, 6.25755096568618e+00, 6.27220116449676e+00, 6.28615852289063e+00,
    6.29944127552623e+00, 6.31206805240621e+00, 6.32405782259477e+00, 6.33542983815165e+00, 6.34620357851803e+00, 6.35639869558413e+00, 6.36603495966142e+00,
    6.37513220657418e+00, 6.38371028607596e+00, 6.39178901178538e+00, 6.39938811282442e+00, 6.40652718732905e+00, 6.41322565798880e+00, 6.41950272975688e+00,
    6.42537734985744e+00, 6.43086817020084e+00, 6.43599351230119e+00, 6.44077133477438e+00, 6.44521920347744e+00, 6.44935426433404e+00, 6.45319321887355e+00,
    6.45675230249514e+00, 6.46004726545201e+00, 6.46309335653540e+00, 6.46590530942274e+00, 6.46849733164024e+00, 6.47088309607648e+00, 6.47307573497091e+00,
    6.47508783628958e+00, 6.47693144238959e+00, 6.47861805086445e+00, 6.48015861745371e+00, 6.48156356089346e+00, 6.48284276957784e+00, 6.48400560989704e+00,
    6.48506093611363e+00, 6.48601710163659e+00, 6.48688197155099e+00, 6.48766293626142e+00, 6.48836692610774e+00, 6.48900042681414e+00, 6.48956949563502e+00,
    6.49007977806523e+00, 6.49053652498664e+00, 6.49094461012855e+00, 6.49130854772528e+00, 6.49163251026077e+00, 6.49192034619726e+00, 6.49217559759228e+00,
    6.49240151751581e+00, 6.49260108718763e+00, 6.49277703276245e+00, 6.49293184169874e+00, 6.49306777865483e+00, 6.49318690086394e+00, 6.49329107294732e+00,
    6.49338198113189e+00, 6.49346114684619e+00, 6.49352993967492e+00, 6.49358958965870e+00, 6.49364119893183e+00, 6.49368575269588e+00, 6.49372412953239e+00,
    6.49375711106216e+00, 6.49378539096283e+00, 6.49380958335986e+00, 6.49383023060923e+00, 6.49384781049274e+00, 6.49386274284900e+00, 6.49387539566481e+00,
    6.49388609065317e+00, 6.49389510834490e+00, 6.49390269272173e+00, 6.49390905541861e+00, 6.49391437952340e+00, 6.49391882300165e+00, 6.49392252177350e+00,
    6.49392559246948e+00, 6.49392813489069e+00, 6.49393023419818e+00, 6.49393196285498e+00, 6.49393338234328e+00, 6.49393454467786e+00, 6.49393549373558e+00,
    6.49393626641951e+00, 6.49393689367490e+00, 6.49393740137299e+00, 6.49393781107719e+00, 6.49393814070514e+00, 6.49393840509889e+00, 6.49393861651425e+00,
    6.49393878503932e+00, 6.49393891895129e+00, 6.49393902501951e+00, 6.49393910876205e+00, 6.49393917466206e+00, 6.49393922634975e+00, 6.49393926675467e+00,
    6.49393929823287e+00, 6.49393932267266e+00, 6.49393934158212e+00, 6.49393935616146e+00, 6.49393936736243e+00, 6.49393937593705e+00, 6.49393938247736e+00,
    6.49393938744770e+00, 6.49393939121092e+00, 6.49393939404951e+00, 6.49393939618253e+00, 6.49393939777921e+00, 6.49393939896976e+00, 6.49393939985400e+00,
    6.49393940050813e+00, 6.49393940099009e+00, 6.49393940134375e+00, 6.49393940160220e+00, 6.49393940179028e+00, 6.49393940192658e+00, 6.49393940202494e+00,
    6.49393940209560e+00, 6.49393940214616e+00, 6.49393940218216e+00, 6.49393940220769e+00, 6.49393940222570e+00, 6.49393940223836e+00, 6.49393940224722e+00,
    6.49393940225338e+00, 6.49393940225765e+00, 6.49393940226059e+00, 6.49393940226261e+00, 6.49393940226399e+00, 6.49393940226493e+00, 6.49393940226557e+00,
    6.49393940226599e+00, 6.49393940226628e+00, 6.49393940226647e+00, 6.49393940226659e+00, 6.49393940226668e+00, 6.49393940226673e+00, 6.49393940226676e+00,
    6.49393940226679e+00, 6.49393940226680e+00, 6.49393940226681e+00, 6.49393940226682e+00, 6.49393940226682e+00, 6.49393940226682e+00, 6.49393940226683e+00,
    6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00,
    6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00,
    6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00,
    6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00,
    6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00,
    6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00,
    6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00,
    6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00,
    6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00,
    6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00, 6.49393940226683e+00};

AMREX_GPU_HOST_DEVICE AMREX_FORCE_INLINE auto planck_small_x(Real x) -> Real
{
  // return x * x * x / 3.0;    // 1st order
  return (-4 + x) * x + 8 * std::log((2 + x) / 2);    // 2nd order
}

AMREX_GPU_HOST_DEVICE AMREX_FORCE_INLINE auto interpolate_planck_integral(Real logx)
{
	/* Note: arr_x must be sorted in ascending order,
		and arr_len must be >= 3. */

	const int arr_len = INTERP_SIZE;
	const int j = (int) ((logx - LOG_X_MIN) / (LOG_X_MAX - LOG_X_MIN) * (arr_len - 1));
  const Real gap = (LOG_X_MAX - LOG_X_MIN) / (arr_len - 1);

	Real y = NAN;
	if ((j < 0) || (j >= arr_len - 1)) {
		y = NAN;
	} else {
		const Real slope = (Y_interp[j + 1] - Y_interp[j]) / gap;
		y = slope * (logx - (LOG_X_MIN + j * gap)) + Y_interp[j];
	}
	return y;
}

// AMREX_GPU_HOST_DEVICE AMREX_FORCE_INLINE auto integral_planck_from_0_to_x(quokka::valarray x, amrex::GpuArray <Real, N> const &X, amrex::GpuArray <Real, N> const &Y, const int X_length) -> Real

// Integrate the Planck integral, x^3 / (exp(x) - 1), from 0 to x. Return its ratio to the integral from 0 to infinity (pi^4 / 15).
AMREX_GPU_HOST_DEVICE AMREX_FORCE_INLINE auto integrate_planck_from_0_to_x(const Real x) -> Real
{
  AMREX_ASSERT(x >= 0.);

  if (x <= 0.) {
		return 0.;
  }

  const Real logx = log10(x);
  Real y = NAN;
  if (logx < LOG_X_MIN) {
    y = planck_small_x(x);
    AMREX_ASSERT(y <= Y_interp[0]);
  } else if (logx >= LOG_X_MAX) {
	  return 1.0;
  } else {
	  y = interpolate_planck_integral(logx);
  }
	assert(!isnan(y));
  return y / gInf;
}
